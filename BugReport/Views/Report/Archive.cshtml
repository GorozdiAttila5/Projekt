@using BugReport.Models.Report;
@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer localizer
@model List<ReportViewModel>
@{
    ViewData["Title"] = localizer["reports"];
}

<div class="main-card">
    <form asp-controller="Report" asp-action="Index" method="get">
        <div class="row align-items-center g-3">
            <div class="col-12 col-md-6">
                <input type="text" name="search" value="@ViewContext.HttpContext.Request.Query["search"]" class="form-control" placeholder="@localizer["search-reports-placeholder"]" />
            </div>

            <div class="col-auto d-flex justify-content-start justify-content-md-center gap-3">
                <div class="dropdown">
                    <button class="btn btn-outline-dark-blue px-4 dropdown-toggle" type="button" id="statusDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        @localizer["filter-status"]
                    </button>
                    <ul class="dropdown-menu p-3" aria-labelledby="statsDropdown" style="min-width:200px;">
                        @foreach (var status in ViewBag.Statuses)
                        {
                            <li>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="statuses" value="@status" id="status_@status">
                                    <label class="form-check-label" for="status_@status">@GetLocalizedStatusName(status, localizer)</label>
                                </div>
                            </li>
                        }
                        <li class="dropdown-divider"></li>
                        <button type="submit" class="btn btn-dark-blue px-4 w-100">@localizer["filter"]</button>
                    </ul>
                </div>

            </div>
        </div>
    </form>

    <div class="table-responsive mt-4">
        <table class="table align-middle report-table">
            <thead class="px-2 mt-4">
                <tr>
                    <th>@localizer["from"]</th>
                    <th>@localizer["title"]</th>
                    <th></th>
                    <th class="text-end">@localizer["modified"]</th>
                </tr>
            </thead>
            <tbody>
                @if (Model is not null && Model.Any())
                {
                    @foreach (var item in Model)
                    {
                        <tr class="clickable-row" data-href="@Url.Action("Details", "Report", new { id = item.Report.Id })">
                            <td>
                                @(item.Report.Reporter != null ? $"{item.Report.Reporter.FirstName} {item.Report.Reporter.LastName}" : localizer["unknown"])
                            </td>
                            <td class="text-truncate title-cell justify-content-between" title="@item.Report.Title">
                                <span class="report-title" style="max-width:500px">
                                    @item.Report.Title
                                </span>
                            </td>
                            <td>
                                @if (item.LatestChangeLog!.Status.Name != null)
                                {
                                    <span class="badge @GetStatusBadgeClass(item.LatestChangeLog.Status.Name) float-end">
                                        @GetLocalizedStatusName(item.LatestChangeLog.Status.Name, localizer)
                                    </span>
                                }
                            </td>
                            <td class="text-end text-muted" style="min-width:150px">
                                @item.LatestChangeLog?.Timestamp.ToString("d")
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="100%" class="title-text text-center">@localizer["no-report-found"]</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@functions {
    public string GetStatusBadgeClass(string normalizedStatus) => normalizedStatus?.ToUpper() switch
    {
        "RESOLVED" => "bg-success",
        "REJECTED" => "bg-danger",
        "BLOCKED" => "bg-warning",
        _ => "bg-dark"
    };

    public string GetLocalizedStatusName(string status, IViewLocalizer localizer)
    {
        return status switch
        {
            "Incoming" => localizer["status-incoming"].Value,
            "In progress" => localizer["status-in-progress"].Value,
            "Resolved" => localizer["status-resolved"].Value,
            "Rejected" => localizer["status-rejected"].Value,
            "Blocked" => localizer["status-blocked"].Value,
            _ => status
        };
    }
}

<script>
    document.addEventListener("DOMContentLoaded", function () {
         document.querySelectorAll(".clickable-row").forEach(row => {
             row.addEventListener("click", () => {
                 window.location = row.dataset.href;
             });
         });
     });
</script>